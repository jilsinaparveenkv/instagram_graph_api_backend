// PS C:\Users\hp\Desktop\insta> node index.js
// Instagram Posts: {
//   data: [
//     {
//       id: '18055827653320041',
//       media_type: 'VIDEO',
//       media_url: 'https://instagram.fcok15-1.fna.fbcdn.net/o1/v/t2/f2/m86/AQOG3gBie5Ua8d1jID8Q0-d6yOFTRtdFwTemlix8i6viyboo0JuJoG8eBBNFW2HImjV_sJJpSizL6-teuEE5JAKg7a2NfaYlwixbHS0.mp4?_nc_cat=104&_nc_oc=AdneTMFed1pcxrrSZTyKDKUmWITW2yNu7Fh4_6_hbQrxGNPSXSLqwERzyl1LzjqErT8&_nc_sid=5e9851&_nc_ht=instagram.fcok15-1.fna.fbcdn.net&_nc_ohc=g7vMhhaTKXsQ7kNvwELCkaw&efg=eyJ2ZW5jb2RlX3RhZyI6Inhwdl9wcm9ncmVzc2l2ZS5JTlNUQUdSQU0uQ0xJUFMuQzMuNzIwLmRhc2hfYmFzZWxpbmVfMV92MSIsInhwdl9hc3NldF9pZCI6MTkwMDczNDE5NzQ2MTQ2MCwiYXNzZXRfYWdlX2RheXMiOjAsInZpX3VzZWNhc2VfaWQiOjEwMDk5LCJkdXJhdGlvbl9zIjoxNywidXJsZ2VuX3NvdXJjZSI6Ind3dyJ9&ccb=17-1&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&edm=ANo9K5cEAAAA&_nc_zt=28&_nc_tpa=Q5bMBQFX5DlN7ZhAPAOFVlkEPsjXnrKeBCILlrxrDgOPB3uKpafBQcLW0f_I-7xHhla9ixFbXmqqKLM8QQ&vs=ece7676ca691e5e3&_nc_vs=HBksFQIYUmlnX3hwdl9yZWVsc19wZXJtYW5lbnRfc3JfcHJvZC8zNzRFMkM5MjRERjBEMTFGRDE0QzE3RjZEQkI4Q0JCQV92aWRlb19kYXNoaW5pdC5tcDQVAALIARIAFQIYOnBhc3N0aHJvdWdoX2V2ZXJzdG9yZS9HQVpNUGlNeGlyWFpWbFlFQU5OMFpBVjFMalVzYnN0VEFRQUYVAgLIARIAKAAYABsCiAd1c2Vfb2lsATEScHJvZ3Jlc3NpdmVfcmVjaXBlATEVAAAmqMe3qqWt4AYVAigCQzMsF0Aw8m6XjU_fGBJkYXNoX2Jhc2VsaW5lXzFfdjERAHX-B2XmnQEA&oh=00_AfgrfST-kmo6egmG9ftgcJymoGzM-ngzaWOpH-G5A6YK9Q&oe=692F68ED',
//       thumbnail_url: 'https://scontent.cdninstagram.com/v/t51.71878-15/589205903_4423796687836229_6498748969300863329_n.jpg?stp=dst-jpg_e35_tt6&_nc_cat=105&ccb=7-5&_nc_sid=18de74&efg=eyJlZmdfdGFnIjoiQ0xJUFMuYmVzdF9pbWFnZV91cmxnZW4uQzMifQ%3D%3D&_nc_ohc=FU-7vobHH3wQ7kNvwEjX8x0&_nc_oc=AdlZE-nFLwKvxwwMoE6-TvIqAYAxAvKVxm8VkmXn7yvSGfsRa4Hxfl8quyA9qb9-pY0&_nc_zt=23&_nc_ht=scontent.cdninstagram.com&edm=ANo9K5cEAAAA&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&oh=00_AfiCSXlCoAoC4dK42SBpfBXjI6wTyP4txFQK7futudBFYg&oe=69336B4C',
//       permalink: 'https://www.instagram.com/reel/DRrwcuJEgdy/',
//       timestamp: '2025-11-30T14:21:51+0000',
//       like_count: 0,
//       comments_count: 0,
//       is_comment_enabled: true
//     },
//     {
//       id: '18087747226797838',
//       media_type: 'VIDEO',
//       media_url: 'https://instagram.fcok15-1.fna.fbcdn.net/o1/v/t2/f2/m86/AQM75zox7T8ZBF5uqvOP63S-C2FULPvjwjuzTtflqoApHCKSTdjtIyn2_7fYPqgROpP3PP56mtz0w6V_d9aLXdIkVui_b0Jbgm5sg3Y.mp4?_nc_cat=110&_nc_oc=AdkorP-jOBDgkukNP2tGiuM1kty79K4DXz6eZqQiZoHEn9NmFJLk2vQqgGg2NSEQR2Y&_nc_sid=5e9851&_nc_ht=instagram.fcok15-1.fna.fbcdn.net&_nc_ohc=RvLYjTJs9iUQ7kNvwGxnJcw&efg=eyJ2ZW5jb2RlX3RhZyI6Inhwdl9wcm9ncmVzc2l2ZS5JTlNUQUdSQU0uQ0xJUFMuQzMuNzIwLmRhc2hfYmFzZWxpbmVfMV92MSIsInhwdl9hc3NldF9pZCI6MTE5NDIzOTU1NjEzODI2NSwiYXNzZXRfYWdlX2RheXMiOjAsInZpX3VzZWNhc2VfaWQiOjEwMDk5LCJkdXJhdGlvbl9zIjoxNywidXJsZ2VuX3NvdXJjZSI6Ind3dyJ9&ccb=17-1&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&edm=ANo9K5cEAAAA&_nc_zt=28&_nc_tpa=Q5bMBQFd-e-P893WdHyKft2buElOtgcSEmLiwI_cHda1T0UjqBPCGHz-4KZKaniOxsh0U4q08eOoPYwYXw&vs=81ec2b4e73e87fbe&_nc_vs=HBksFQIYUmlnX3hwdl9yZWVsc19wZXJtYW5lbnRfc3JfcHJvZC84NjQxNzM5MDFFOTA1RkQ4QTc2MjdFMkQ2REVCMTFCQV92aWRlb19kYXNoaW5pdC5tcDQVAALIARIAFQIYOnBhc3N0aHJvdWdoX2V2ZXJzdG9yZS9HSDVPWXlPV0xTTDhwOWNDQUFnaWJVemlRdjVVYnN0VEFRQUYVAgLIARIAKAAYABsCiAd1c2Vfb2lsATEScHJvZ3Jlc3NpdmVfcmVjaXBlATEVAAAmstSpiPKJnwQVAigCQzMsF0Aw8m6XjU_fGBJkYXNoX2Jhc2VsaW5lXzFfdjERAHX-B2XmnQEA&oh=00_AfhWJcwSrSq2dvWuDFF584gfiZtIesHvOdpFtuyi63DiBA&oe=692F5EB3',
//       thumbnail_url: 'https://scontent.cdninstagram.com/v/t51.71878-15/587784839_1421323352979841_794840522624594426_n.jpg?stp=dst-jpg_e35_tt6&_nc_cat=108&ccb=7-5&_nc_sid=18de74&efg=eyJlZmdfdGFnIjoiQ0xJUFMuYmVzdF9pbWFnZV91cmxnZW4uQzMifQ%3D%3D&_nc_ohc=vWKOcv4dOBkQ7kNvwEl28aR&_nc_oc=AdmymlnJw-2PoOzCI_yVw9PDQg7gdYbWDjaprb11sAM1tBUcUCS44XaLr7OnxE9HlNw&_nc_zt=23&_nc_ht=scontent.cdninstagram.com&edm=ANo9K5cEAAAA&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&oh=00_AfhAIhOPA4n5ATTPS7aobcchmawPs7CpzXZLYFJX1pL1ew&oe=69336038',
//       permalink: 'https://www.instagram.com/reel/DRrwEmmkvjM/',
//       timestamp: '2025-11-30T14:18:47+0000',
//       like_count: 0,
//       comments_count: 0,
//       is_comment_enabled: true
//     },
//     {
//       id: '17859304500555963',
//       media_type: 'VIDEO',
//       media_url: 'https://instagram.fcok15-1.fna.fbcdn.net/o1/v/t2/f2/m86/AQMSSQQWkm42rtBQeFm--yMUReVXE-RpfYnHV70Pvji1pzlY-wpbJW00tG4Hv7cGn6pGKrD1RXc0mFlbC7aQNwP3nagEbaXUUWI2mow.mp4?_nc_cat=109&_nc_oc=Adk9b51KZhrQCrhHGaPVf5joVLFq_CyNAldjVs1_x7RGP5ugOO9siQ_b4Z5jWuvA4AE&_nc_sid=5e9851&_nc_ht=instagram.fcok15-1.fna.fbcdn.net&_nc_ohc=98m0lzMd5-8Q7kNvwGZvBiT&efg=eyJ2ZW5jb2RlX3RhZyI6Inhwdl9wcm9ncmVzc2l2ZS5JTlNUQUdSQU0uQ0xJUFMuQzMuNzIwLmRhc2hfYmFzZWxpbmVfMV92MSIsInhwdl9hc3NldF9pZCI6ODA0NDcxOTcyNTg5MDU4LCJhc3NldF9hZ2VfZGF5cyI6MCwidmlfdXNlY2FzZV9pZCI6MTAwOTksImR1cmF0aW9uX3MiOjE3LCJ1cmxnZW5fc291cmNlIjoid3d3In0%3D&ccb=17-1&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&edm=ANo9K5cEAAAA&_nc_zt=28&_nc_tpa=Q5bMBQF1paXIFNpOdtMAZu6aSusuSiadgh2QlrHtW2QyWAXFdsEleHSU7AZbPbZRFhzz4ETu3icW_TiEHQ&vs=43aa3d68b66416be&_nc_vs=HBksFQIYUmlnX3hwdl9yZWVsc19wZXJtYW5lbnRfc3JfcHJvZC8zNzRGNDlCRDZEMUNEOTE4RUEyNzVGNjM3NDA5N0VCOF92aWRlb19kYXNoaW5pdC5tcDQVAALIARIAFQIYOnBhc3N0aHJvdWdoX2V2ZXJzdG9yZS9HRXNsU3lNUVE0blhPcVlDQUkwQ0Fieml6VFpLYnN0VEFRQUYVAgLIARIAKAAYABsCiAd1c2Vfb2lsATEScHJvZ3Jlc3NpdmVfcmVjaXBlATEVAAAmhLjDorfq7QIVAigCQzMsF0Aw8m6XjU_fGBJkYXNoX2Jhc2VsaW5lXzFfdjERAHX-B2XmnQEA&oh=00_AfgKF41PE4FCfk3K9wmP9CW93Yp4pjZ8RSSWKMsAWQKz5A&oe=692F54B2',
//       thumbnail_url: 'https://scontent.cdninstagram.com/v/t51.71878-15/587720314_1276451630974920_2642980531975148438_n.jpg?stp=dst-jpg_e35_tt6&_nc_cat=107&ccb=7-5&_nc_sid=18de74&efg=eyJlZmdfdGFnIjoiQ0xJUFMuYmVzdF9pbWFnZV91cmxnZW4uQzMifQ%3D%3D&_nc_ohc=hvonffHk0B4Q7kNvwFiThKS&_nc_oc=AdkSW_GUrte6xAE6p7px0kjtw9NyNnCjZzrIFuwVNFhSpSEajnjx9bLeOlIDKx3pXpw&_nc_zt=23&_nc_ht=scontent.cdninstagram.com&edm=ANo9K5cEAAAA&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&oh=00_Afgtn9_4x-ymr_vzExUaTT5cAug6uJYPzKRBYCTmaVXEYw&oe=6933412B',
//       permalink: 'https://www.instagram.com/reel/DRrvp6Qksmu/',
//       timestamp: '2025-11-30T14:15:36+0000',
//       like_count: 0,
//       comments_count: 0,
//       is_comment_enabled: true
//     },
//     {
//       id: '18104814316646425',
//       media_type: 'VIDEO',
//       media_url: 'https://instagram.fcok15-1.fna.fbcdn.net/o1/v/t2/f2/m86/AQMiZaQjNANh-4cYUbCE9jl_Q3J6fYUV0r_Zc1spBCJ05UDJAsAPIVsGiZUqKGNhRZ-ylvqrRorkFhY4yTsCkkK5yIafz3Mb0w8_k8c.mp4?_nc_cat=100&_nc_oc=AdkQrPK2oJnAQhtuzwP2J0dAx-_dpEeSKCk1cmImWZW-ElWa6Lx0tFrEJ2FnBeeJudM&_nc_sid=5e9851&_nc_ht=instagram.fcok15-1.fna.fbcdn.net&_nc_ohc=ebGF3nI5T6IQ7kNvwFnA842&efg=eyJ2ZW5jb2RlX3RhZyI6Inhwdl9wcm9ncmVzc2l2ZS5JTlNUQUdSQU0uQ0xJUFMuQzMuNDgwLmRhc2hfYmFzZWxpbmVfMV92MSIsInhwdl9hc3NldF9pZCI6Njk3MjI3MDQ2NzkwMzYzLCJhc3NldF9hZ2VfZGF5cyI6MSwidmlfdXNlY2FzZV9pZCI6MTAwOTksImR1cmF0aW9uX3MiOjcsInVybGdlbl9zb3VyY2UiOiJ3d3cifQ%3D%3D&ccb=17-1&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&edm=ANo9K5cEAAAA&_nc_zt=28&_nc_tpa=Q5bMBQHJDNW09ttLTxd-29bJWD9WhaSwwShtMVP9hv_LEqX3mdofAduzbv3sczc6_e9jlEbXzzAxFyBxjg&vs=eb6f0e02a92ccc7a&_nc_vs=HBksFQIYUmlnX3hwdl9yZWVsc19wZXJtYW5lbnRfc3JfcHJvZC84NjQ5QTE1ODUzRjMwQjNGRjkwMTIyM0JDRTMxMUQ5QV92aWRlb19kYXNoaW5pdC5tcDQVAALIARIAFQIYOnBhc3N0aHJvdWdoX2V2ZXJzdG9yZS9HSWtHTUNQOEswYXRRUEFFQUR4MWNiNE52amtBYnN0VEFRQUYVAgLIARIAKAAYABsCiAd1c2Vfb2lsATEScHJvZ3Jlc3NpdmVfcmVjaXBlATEVAAAmtpOdp_qHvQIVAigCQzMsF0AeAAAAAAAAGBJkYXNoX2Jhc2VsaW5lXzFfdjERAHX-B2XmnQEA&oh=00_AfhBTt8bIdaP6p11GZOCgBKar6itXp6WmLDyGt3eMf9Big&oe=692F5035',
//       thumbnail_url: 'https://scontent.cdninstagram.com/v/t51.71878-15/588165550_1350271572865924_1501260305604749245_n.jpg?stp=dst-jpg_e35_tt6&_nc_cat=107&ccb=7-5&_nc_sid=18de74&efg=eyJlZmdfdGFnIjoiQ0xJUFMuYmVzdF9pbWFnZV91cmxnZW4uQzMifQ%3D%3D&_nc_ohc=pMbVvx2v0doQ7kNvwFeZju9&_nc_oc=AdnZsVWswHcy_vs5d9GaAzEMImmsfAcAu64t25HCf6ytc2eUMPeckjC7V9W47n-6alU&_nc_zt=23&_nc_ht=scontent.cdninstagram.com&edm=ANo9K5cEAAAA&_nc_gid=fcA3KTKW-Mt80y8GMHdqbQ&oh=00_AfghTsf-hlrRiIsAvhd3dkPidW9rjNTfqEVKnNInLhCk2w&oe=693366BA',
//       permalink: 'https://www.instagram.com/reel/DRrJxziEvn8/',
//       timestamp: '2025-11-30T08:41:21+0000',
//       like_count: 1,
//       comments_count: 1,
//       is_comment_enabled: true
//     }
//   ],
//   paging: {
//     cursors: {
//       before: 'QVFIU1NHREpobjZASUFpVWkkyN19OVUJtczFXRmRoVzRmc2M1Y3U3X0tZAR0JBdk95VDdOTU5jY2tPXzZAHbE5vcWZADUnlUQnp4SjhOWDAwSXQzMzdUMUk4SW5B',
//       after: 'QVFIU3h6dnVFRGpIUlpGTEZArZAmZAET0o4UGp1SGJLeW9vVm1JRWprZAEZAodG1obl8ycktuSDVzMHJLbnFJdXppdWwydHhOLU8yaTlMX1dpRFRCeVRCZAzBzcHF3'
//     }
//   }
// }
// PS C:\Users\hp\Desktop\insta>






// 1.withou api 
// const axios = require("axios");

// async function getInstagramPosts() {
//   const accessToken = "IGAAWh9QiLjBVBZAFRSVjhiLUFCcnhaY042WnlIRS00LTdoV1hBLWtlZAWpHWnJLYnoxMmZAQVWxlamc3QVF1VGJUbUF4a3lzSXdjMlF5V2hHRXlsT1dkZAHk0eWhyeWhBN0xPR3A3LTZAKVlEzX2hDMVFsUmdQeE9McFRYdUh1cGN0UQZDZD";   // Replace
// //   const userId = "1585448665975829";                        
//   const userId = "17841478582560390";                         
//   const url = `https://graph.instagram.com/${userId}/media?fields=
//   id,
//   caption,
//   media_type,
//   media_url,
//   thumbnail_url,
//   permalink,
//   timestamp,
//   like_count,
//   comments_count,
//   is_comment_enabled,
//   children{media_url,media_type,thumbnail_url},
//   comments.limit(50){id,text,timestamp,like_count,username}
// &access_token=${accessToken}`;


//   try {
//     const response = await axios.get(url);
//     console.log("Instagram Posts:", response.data);
//     return response.data;
//   } catch (error) {
//     console.error("Error fetching Instagram posts:", error.response?.data || error.message);
//   }
// }

// getInstagramPosts();






// 2.with api
// const express = require('express');
// const axios = require('axios');
// const app = express();
// const port = 3000;

// // IMPORTANT: Replace with your actual credentials!
// // This should ideally be stored in a .env file for security.
// const INSTAGRAM_ACCESS_TOKEN = "IGAAWh9QiLjBVBZAFRSVjhiLUFCcnhaY042WnlIRS00LTdoV1hBLWtlZAWpHWnJLYnoxMmZAQVWxlamc3QVF1VGJUbUF4a3lzSXdjMlF5V2hHRXlsT1dkZAHk0eWhyeWhBN0xPR3A3LTZAKVlEzX2hDMVFsUmdQeE9McFRYdUh1cGN0UQZDZD";
// const INSTAGRAM_USER_ID = "17841478582560390"; 

// // --- Data Fetching Logic (Based on your provided code) ---
// async function fetchInstagramPosts() {
//   const fields = `id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,like_count,comments_count,is_comment_enabled,children{media_url,media_type,thumbnail_url},comments.limit(50){id,text,timestamp,like_count,username}`;
  
//   const url = `https://graph.instagram.com/${INSTAGRAM_USER_ID}/media?fields=${fields}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;

//   try {
//     const response = await axios.get(url);
//     // The response.data will contain an object with a 'data' array of posts
//     return response.data;
//   } catch (error) {
//     console.error("Error fetching Instagram posts from API:", error.response?.data || error.message);
//     // Throw an error to be handled by the Express route
//     throw new Error('Failed to fetch data from Instagram.');
//   }
// }

// // --- Express Server Configuration ---

// // Enable CORS (Cross-Origin Resource Sharing) for frontend access
// app.use((req, res, next) => {
//   // Replace '*' with your specific frontend domain (e.g., 'http://localhost:5173') for production
//   res.header('Access-Control-Allow-Origin', '*'); 
//   res.header('Access-Control-Allow-Methods', 'GET, OPTIONS');
//   res.header('Access-Control-Allow-Headers', 'Content-Type');
//   next();
// });


// // API Endpoint: GET /api/instagram
// app.get('/api/instagram', async (req, res) => {
//   console.log("Request received for Instagram posts.");
//   try {
//     const postsData = await fetchInstagramPosts();
//     // Send the data back to the frontend
//     res.json(postsData);
//   } catch (error) {
//     // Send a 500 status code if the fetch failed
//     res.status(500).json({ error: error.message });
//   }
// });

// // Start the server
// app.listen(port, () => {
//   console.log(`Server running at http://localhost:${port}`);
//   console.log(`Instagram API endpoint available at http://localhost:${port}/api/instagram`);
// });







// const express = require('express');
// const axios = require('axios');
// const cors = require('cors');
// // .env file package for securely loading environment variables
// const dotenv = require('dotenv'); 

// // Load environment variables from .env file (you must create this file)
// dotenv.config();

// const app = express();
// const port = process.env.PORT || 3000;

// // Access credentials securely from environment variables
// // Make sure you define these in a file named .env
// const INSTAGRAM_ACCESS_TOKEN = process.env.INSTAGRAM_ACCESS_TOKEN;
// const INSTAGRAM_USER_ID = process.env.INSTAGRAM_USER_ID; 

// // --- CORS Configuration ---
// // This uses the 'cors' package to safely handle cross-origin requests.
// // During development, we allow all origins (*).
// // In a real application, you would restrict this to your frontend URL: 
// // app.use(cors({ origin: 'http://localhost:5173' })); 
// app.use(cors());

// // --- Data Fetching Logic ---
// async function fetchInstagramPosts() {
//   if (!INSTAGRAM_ACCESS_TOKEN || !INSTAGRAM_USER_ID) {
//     console.error("Missing Instagram credentials. Check your .env file.");
//     throw new Error('API Credentials are not set on the server.');
//   }

//   // All fields are correctly formatted into a single string for the URL
//   const fields = `id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,like_count,comments_count,is_comment_enabled,children{media_url,media_type,thumbnail_url},comments.limit(50){id,text,timestamp,like_count,username}`;
  
//   const url = `https://graph.instagram.com/${INSTAGRAM_USER_ID}/media?fields=${fields}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;

//   try {
//     const response = await axios.get(url);
//     // The response.data will contain an object with a 'data' array of posts
//     return response.data;
//   } catch (error) {
//     console.error("Error fetching Instagram posts from API:", error.response?.data || error.message);
//     // Throw an error to be handled by the Express route
//     throw new Error('Failed to fetch data from Instagram.');
//   }
// }

// // --- API Endpoint: GET /api/instagram ---
// app.get('/api/instagram', async (req, res) => {
//   console.log(`[${new Date().toISOString()}] Request received for Instagram posts.`);
//   try {
//     const postsData = await fetchInstagramPosts();
//     // Send the data back to the frontend
//     res.json(postsData);
//   } catch (error) {
//     // Send a 500 status code if the fetch failed
//     res.status(500).json({ error: error.message });
//   }
// });

// // --- Server Startup ---
// app.listen(port, () => {
//   console.log(`Server running at http://localhost:${port}`);
//   console.log(`API endpoint: http://localhost:${port}/api/instagram`);
//   console.log(`---`);
//   console.log("NOTE: This server requires a .env file with INSTAGRAM_ACCESS_TOKEN and INSTAGRAM_USER_ID.");
// });



const express = require('express');
const axios = require('axios');
const cors = require('cors');
// .env file package for securely loading environment variables
const dotenv = require('dotenv'); 

// Load environment variables from .env file (you must create this file)
dotenv.config();

const app = express();
const port = process.env.PORT || 3000;

// Access credentials securely from environment variables
// Make sure you define these in a file named .env
const INSTAGRAM_ACCESS_TOKEN = process.env.INSTAGRAM_ACCESS_TOKEN;
const INSTAGRAM_USER_ID = process.env.INSTAGRAM_USER_ID; 

// --- CORS Configuration ---
// This uses the 'cors' package to safely handle cross-origin requests.
// During development, we allow all origins (*).
// In a real application, you would restrict this to your frontend URL: 
// app.use(cors({ origin: 'http://localhost:5173' })); 
app.use(cors());

// --- Data Fetching Logic ---
async function fetchInstagramPosts() {
  if (!INSTAGRAM_ACCESS_TOKEN || !INSTAGRAM_USER_ID) {
    console.error("Missing Instagram credentials. Check your .env file.");
    throw new Error('API Credentials are not set on the server.');
  }

  // All fields are correctly formatted into a single string for the URL
  const fields = `id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,like_count,comments_count,is_comment_enabled,children{media_url,media_type,thumbnail_url},comments.limit(50){id,text,timestamp,like_count,username}`;
  
  const url = `https://graph.instagram.com/${INSTAGRAM_USER_ID}/media?fields=${fields}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;

  try {
    const response = await axios.get(url);
    // The response.data will contain an object with a 'data' array of posts
    return response.data;
  } catch (error) {
    console.error("Error fetching Instagram posts from API:", error.response?.data || error.message);
    // Throw an error to be handled by the Express route
    throw new Error('Failed to fetch data from Instagram.');
  }
}

// --- API Endpoint: GET /api/instagram ---
app.get('/api/instagram', async (req, res) => {
  console.log(`[${new Date().toISOString()}] Request received for Instagram posts.`);
  try {
    const postsData = await fetchInstagramPosts();
    // Send the data back to the frontend
    res.json(postsData);
  } catch (error) {
    // Send a 500 status code if the fetch failed
    res.status(500).json({ error: error.message });
  }
});
// --- API Endpoint: GET /api/instagram/stats ---
app.get('/api/instagram/stats', async (req, res) => {
  console.log(`[${new Date().toISOString()}] Request received for Instagram stats.`);

  if (!INSTAGRAM_ACCESS_TOKEN || !INSTAGRAM_USER_ID) {
    return res.status(500).json({ error: "Missing Instagram credentials in .env" });
  }

  try {
    // Fetch media posts
    const fields = `id,media_type,like_count,comments_count,children{media_url,media_type},permalink,caption,media_url,timestamp`;
    const url = `https://graph.instagram.com/${INSTAGRAM_USER_ID}/media?fields=${fields}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;
    const response = await axios.get(url);
    const posts = response.data.data || [];

    // Compute stats
    const stats = {
      totalViews: posts.reduce((sum, post) => sum + (post.like_count || 0), 0), // Sum of likes as proxy for views
      reelsPosted: posts.filter(p => p.media_type === 'VIDEO' || p.media_type === 'REELS').length,
      activeUsers: posts.reduce((sum, post) => sum + (post.comments_count || 0), 0), // Could be changed based on your definition
      totalShare: 0, // Instagram API does not expose shares, will need approximation if possible
    };

    res.json(stats);
  } catch (error) {
    console.error("Error fetching Instagram stats:", error.response?.data || error.message);
    res.status(500).json({ error: "Failed to fetch Instagram stats" });
  }
});


// --- Server Startup ---
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
  console.log(`API endpoint: http://localhost:${port}/api/instagram`);
  console.log(`---`);
  console.log("NOTE: This server requires a .env file with INSTAGRAM_ACCESS_TOKEN and INSTAGRAM_USER_ID.");
});





